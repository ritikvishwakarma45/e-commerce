<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="'/admin/items'"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ isEditMode ? 'Edit Item' : 'Add Item' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="form-container">
    <!-- Loading Spinner -->
    @if (isLoading) {
      <div class="loading-container">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Loading item details...</p>
      </div>
    }

    <!-- Item Form -->
    @if (!isLoading) {
      <form [formGroup]="itemForm" (ngSubmit)="onSubmit()">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Item Information</ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <!-- Item Name -->
          <ion-item [class.ion-invalid]="isFieldInvalid('name')" lines="full">
            <ion-label position="stacked">Item Name *</ion-label>
            <ion-input
              formControlName="name"
              placeholder="Enter item name"
              maxlength="100">
            </ion-input>
            @if (isFieldInvalid('name')) {
              <ion-note slot="error">
                {{ getFieldError('name') }}
              </ion-note>
            }
          </ion-item>

          <!-- Description -->
          <ion-item [class.ion-invalid]="isFieldInvalid('description')" lines="full">
            <ion-label position="stacked">Description</ion-label>
            <ion-textarea
              formControlName="description"
              placeholder="Enter item description (optional)"
              rows="3"
              maxlength="500">
            </ion-textarea>
            @if (isFieldInvalid('description')) {
              <ion-note slot="error">
                {{ getFieldError('description') }}
              </ion-note>
            }
          </ion-item>

          <!-- Category -->
          <ion-item [class.ion-invalid]="isFieldInvalid('categoryId')" lines="full">
            <ion-label position="stacked">Category *</ion-label>
            <ion-select
              formControlName="categoryId"
              placeholder="Select a category"
              interface="popover">
              @for (category of categories; track category.id) {
                <ion-select-option [value]="category.id">
                  {{ category.name }}
                </ion-select-option>
              }
            </ion-select>
            @if (isFieldInvalid('categoryId')) {
              <ion-note slot="error">
                {{ getFieldError('categoryId') }}
              </ion-note>
            }
          </ion-item>

          <!-- Price -->
          <ion-item [class.ion-invalid]="isFieldInvalid('price')" lines="full">
            <ion-label position="stacked">Price ($)</ion-label>
            <ion-input
              formControlName="price"
              type="number"
              step="0.01"
              min="0"
              placeholder="0.00 (optional)">
            </ion-input>
            @if (isFieldInvalid('price')) {
              <ion-note slot="error">
                {{ getFieldError('price') }}
              </ion-note>
            }
          </ion-item>

          <!-- Image URL -->
          <ion-item [class.ion-invalid]="isFieldInvalid('imageUrl')" lines="full">
            <ion-label position="stacked">Image URL</ion-label>
            <ion-input
              formControlName="imageUrl"
              placeholder="https://example.com/image.jpg">
            </ion-input>
            @if (isFieldInvalid('imageUrl')) {
              <ion-note slot="error">
                {{ getFieldError('imageUrl') }}
              </ion-note>
            }
          </ion-item>

          <!-- Image Preview -->
          @if (itemForm.get('imageUrl')?.value) {
            <div class="image-preview">
              <img [src]="itemForm.get('imageUrl')?.value" [alt]="itemForm.get('name')?.value" />
            </div>
          }

          <!-- Active Status -->
          <ion-item lines="none">
            <ion-checkbox formControlName="isActive" slot="start"></ion-checkbox>
            <ion-label>
              <h3>Active Item</h3>
              <p>Item will be available for selection in products</p>
            </ion-label>
          </ion-item>
        </ion-card-content>
      </ion-card>

      <!-- Specifications -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            Specifications
            <ion-button fill="clear" size="small" (click)="addSpecification()">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Add
            </ion-button>
          </ion-card-title>
        </ion-card-header>

        <ion-card-content>
          @if (specificationsArray.length === 0) {
            <div class="no-specs">
              <p>No specifications added yet. Click "Add" to add specifications.</p>
            </div>
          }

          @if (specificationsArray.length > 0) {
            <ion-list>
              @for (spec of specificationsArray.controls; track $index; let i = $index) {
                <div class="spec-group">
                  <div class="spec-inputs">
                    <ion-item lines="none">
                      <ion-label position="stacked">Property</ion-label>
                      <ion-input
                        [formControl]="$any(spec.get('key'))"
                        placeholder="e.g., Color, Size, Material">
                      </ion-input>
                    </ion-item>
                    
                    <ion-item lines="none">
                      <ion-label position="stacked">Value</ion-label>
                      <ion-input
                        [formControl]="$any(spec.get('value'))"
                        placeholder="e.g., Red, Large, Cotton">
                      </ion-input>
                    </ion-item>

                    <ion-button 
                      fill="clear" 
                      color="danger" 
                      size="small" 
                      (click)="removeSpecification(i)">
                      <ion-icon name="trash-outline"></ion-icon>
                    </ion-button>
                  </div>
                </div>
              }
            </ion-list>
          }
        </ion-card-content>
      </ion-card>

      <!-- Form Actions -->
      <div class="form-actions">
        <ion-button
          expand="block"
          type="submit"
          [disabled]="isSaving || itemForm.invalid"
          color="primary">
          @if (isSaving) {
            <ion-spinner name="crescent" slot="start"></ion-spinner>
          } @else {
            <ion-icon name="save-outline" slot="start"></ion-icon>
          }
          {{ isSaving ? 'Saving...' : (isEditMode ? 'Update Item' : 'Create Item') }}
        </ion-button>

        <ion-button
          expand="block"
          fill="outline"
          (click)="cancel()"
          [disabled]="isSaving">
          <ion-icon name="close-outline" slot="start"></ion-icon>
          Cancel
        </ion-button>
      </div>
      </form>
    }
  </div>
</ion-content>
